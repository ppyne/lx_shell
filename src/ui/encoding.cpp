#include "encoding.h"

/*
 * Table de correspondance Unicode (U+00A0–U+00FF) -> CP437
 * Limité volontairement aux caractères latins courants
 */
typedef struct {
    uint16_t unicode;
    uint8_t  cp437;
} utf8_cp437_t;

static const utf8_cp437_t utf8_cp437_table[] = {
    { 0x263A, 0x01 }, // ☺︎
    { 0x263B, 0x02 }, // ☻
    { 0x2665, 0x03 }, // ♥︎
    { 0x2666, 0x04 }, // ♦︎
    { 0x2663, 0x05 }, // ♣︎
    { 0x2660, 0x06 }, // ♠︎
    { 0x2022, 0x07 }, // •
    { 0x25D8, 0x08 }, // ◘
    { 0x25CB, 0x09 }, // ○
    { 0x25D9, 0x0a }, // ◙
    { 0x2642, 0x0b }, // ♂︎
    { 0x2640, 0x0c }, // ♀︎
    { 0x266A, 0x0d }, // ♪
    { 0x266B, 0x0e }, // ♫[
    { 0x263C, 0x0f }, // ☼
    { 0x25BA, 0x10 }, // ►
    { 0x25C4, 0x11 }, // ◄
    { 0x2195, 0x12 }, // ↕︎
    { 0x203C, 0x13 }, // ‼︎
    { 0x00B6, 0x14 }, // ¶
    { 0x00A7, 0x15 }, // §
    { 0x25AC, 0x16 }, // ▬
    { 0x21A8, 0x17 }, // ↨
    { 0x2191, 0x18 }, // ↑
    { 0x2193, 0x19 }, // ↓
    { 0x2192, 0x1a }, // →
    { 0x2190, 0x1b }, // ←
    { 0x221F, 0x1c }, // ∟
    { 0x2194, 0x1d }, // ↔︎
    { 0x25B2, 0x1e }, // ▲
    { 0x25BC, 0x1f }, // ▼
    { 0x0020, 0x20 }, // SPACE
    { 0x0021, 0x21 }, // !
    { 0x0022, 0x22 }, // "
    { 0x0023, 0x23 }, // #
    { 0x0024, 0x24 }, // $
    { 0x0025, 0x25 }, // %
    { 0x0026, 0x26 }, // &
    { 0x0027, 0x27 }, // '
    { 0x0028, 0x28 }, // (
    { 0x0029, 0x29 }, // )
    { 0x002a, 0x2a }, // *
    { 0x002b, 0x2b }, // +
    { 0x002c, 0x2c }, // ,
    { 0x002d, 0x2d }, // -
    { 0x002e, 0x2e }, // .
    { 0x002f, 0x2f }, // /
    { 0x0030, 0x30 }, // 0
    { 0x0031, 0x31 }, // 1
    { 0x0032, 0x32 }, // 2
    { 0x0033, 0x33 }, // 3
    { 0x0034, 0x34 }, // 4
    { 0x0035, 0x35 }, // 5
    { 0x0036, 0x36 }, // 6
    { 0x0037, 0x37 }, // 7
    { 0x0038, 0x38 }, // 8
    { 0x0039, 0x39 }, // 9
    { 0x003a, 0x3a }, // :
    { 0x003b, 0x3b }, // ;
    { 0x003c, 0x3c }, // <
    { 0x003d, 0x3d }, // =
    { 0x003e, 0x3e }, // >
    { 0x003f, 0x3f }, // ?
    { 0x0040, 0x40 }, // @
    { 0x0041, 0x41 }, // A
    { 0x0042, 0x42 }, // B
    { 0x0043, 0x43 }, // C
    { 0x0044, 0x44 }, // D
    { 0x0045, 0x45 }, // E
    { 0x0046, 0x46 }, // F
    { 0x0047, 0x47 }, // G
    { 0x0048, 0x48 }, // H
    { 0x0049, 0x49 }, // I
    { 0x004a, 0x4a }, // J
    { 0x004b, 0x4b }, // K
    { 0x004c, 0x4c }, // L
    { 0x004d, 0x4d }, // M
    { 0x004e, 0x4e }, // N
    { 0x004f, 0x4f }, // O
    { 0x0050, 0x50 }, // P
    { 0x0051, 0x51 }, // Q
    { 0x0052, 0x52 }, // R
    { 0x0053, 0x53 }, // S
    { 0x0054, 0x54 }, // T
    { 0x0055, 0x55 }, // U
    { 0x0056, 0x56 }, // V
    { 0x0057, 0x57 }, // W
    { 0x0058, 0x58 }, // X
    { 0x0059, 0x59 }, // Y
    { 0x005a, 0x5a }, // Z
    { 0x005b, 0x5b }, // [
    { 0x005c, 0x5c }, // backslash
    { 0x005d, 0x5d }, // ]
    { 0x005e, 0x5e }, // ^
    { 0x005f, 0x5f }, // _
    { 0x0060, 0x60 }, // `
    { 0x0061, 0x61 }, // a
    { 0x0062, 0x62 }, // b
    { 0x0063, 0x63 }, // c
    { 0x0064, 0x64 }, // d
    { 0x0065, 0x65 }, // e
    { 0x0066, 0x66 }, // f
    { 0x0067, 0x67 }, // g
    { 0x0068, 0x68 }, // h
    { 0x0069, 0x69 }, // i
    { 0x006a, 0x6a }, // j
    { 0x006b, 0x6b }, // k
    { 0x006c, 0x6c }, // l
    { 0x006d, 0x6d }, // m
    { 0x006e, 0x6e }, // n
    { 0x006f, 0x6f }, // o
    { 0x0070, 0x70 }, // p
    { 0x0071, 0x71 }, // q
    { 0x0072, 0x72 }, // r
    { 0x0073, 0x73 }, // s
    { 0x0074, 0x74 }, // t
    { 0x0075, 0x75 }, // u
    { 0x0076, 0x76 }, // v
    { 0x0077, 0x77 }, // w
    { 0x0078, 0x78 }, // x
    { 0x0079, 0x79 }, // y
    { 0x007a, 0x7a }, // z
    { 0x007b, 0x7b }, // {
    { 0x007c, 0x7c }, // |
    { 0x007d, 0x7d }, // }
    { 0x007e, 0x7e }, // ~
    { 0x2302, 0x7f }, // ⌂
    { 0x00C7, 0x80 }, // Ç
    { 0x00FC, 0x81 }, // ü
    { 0x00E9, 0x82 }, // é
    { 0x00E2, 0x83 }, // â
    { 0x00E4, 0x84 }, // ä
    { 0x00E0, 0x85 }, // à
    { 0x00E5, 0x86 }, // å
    { 0x00E7, 0x87 }, // ç
    { 0x00EA, 0x88 }, // ê
    { 0x00EB, 0x89 }, // ë
    { 0x00E8, 0x8a }, // è
    { 0x00EF, 0x8b }, // ï
    { 0x00EE, 0x8c }, // î
    { 0x00EC, 0x8d }, // ì
    { 0x00C4, 0x8e }, // Ä
    { 0x00C5, 0x8f }, // Å
    { 0x00C9, 0x90 }, // É
    { 0x00E6, 0x91 }, // æ
    { 0x00C6, 0x92 }, // Æ
    { 0x00F4, 0x93 }, // ô
    { 0x00F6, 0x94 }, // ö
    { 0x00F2, 0x95 }, // ò
    { 0x00FB, 0x96 }, // û
    { 0x00F9, 0x97 }, // ù
    { 0x00FF, 0x98 }, // ÿ
    { 0x00D6, 0x99 }, // Ö
    { 0x00DC, 0x9a }, // Ü
    { 0x00A2, 0x9b }, // ¢
    { 0x00A3, 0x9c }, // £
    { 0x00A5, 0x9d }, // ¥
    { 0x20A7, 0x9e }, // ₧
    { 0x0192, 0x9f }, // ƒ
    { 0x00E1, 0xa0 }, // á
    { 0x00ED, 0xa1 }, // í
    { 0x00F3, 0xa2 }, // ó
    { 0x00FA, 0xa3 }, // ú
    { 0x00F1, 0xa4 }, // ñ
    { 0x00D1, 0xa5 }, // Ñ
    { 0x00AA, 0xa6 }, // ª
    { 0x00BA, 0xa7 }, // º
    { 0x00BF, 0xa8 }, // ¿
    { 0x2310, 0xa9 }, // ⌐
    { 0x00AC, 0xaa }, // ¬
    { 0x00BD, 0xab }, // ½
    { 0x00BC, 0xac }, // ¼
    { 0x00A1, 0xad }, // ¡
    { 0x00AB, 0xae }, // «
    { 0x00BB, 0xaf }, // »
    { 0x2591, 0xb0 }, // ░
    { 0x2592, 0xb1 }, // ▒
    { 0x2593, 0xb2 }, // ▓
    { 0x2502, 0xb3 }, // │
    { 0x2524, 0xb4 }, // ┤
    { 0x2561, 0xb5 }, // ╡
    { 0x2562, 0xb6 }, // ╢
    { 0x2556, 0xb7 }, // ╖
    { 0x2555, 0xb8 }, // ╕
    { 0x2563, 0xb9 }, // ╣
    { 0x2551, 0xba }, // ║
    { 0x2557, 0xbb }, // ╗
    { 0x255D, 0xbc }, // ╝
    { 0x255C, 0xbd }, // ╜
    { 0x255B, 0xbe }, // ╛
    { 0x2510, 0xbf }, // ┐
    { 0x2514, 0xc0 }, // └
    { 0x2534, 0xc1 }, // ┴
    { 0x252C, 0xc2 }, // ┬
    { 0x251C, 0xc3 }, // ├
    { 0x2500, 0xc4 }, // ─
    { 0x253C, 0xc5 }, // ┼
    { 0x255E, 0xc6 }, // ╞
    { 0x255F, 0xc7 }, // ╟
    { 0x255A, 0xc8 }, // ╚
    { 0x2554, 0xc9 }, // ╔
    { 0x2569, 0xca }, // ╩
    { 0x2566, 0xcb }, // ╦
    { 0x2560, 0xcc }, // ╠
    { 0x2550, 0xcd }, // ═
    { 0x256C, 0xce }, // ╬
    { 0x2567, 0xcf }, // ╧
    { 0x2568, 0xd0 }, // ╨
    { 0x2564, 0xd1 }, // ╤
    { 0x2565, 0xd2 }, // ╥
    { 0x2559, 0xd3 }, // ╙
    { 0x2558, 0xd4 }, // ╘
    { 0x2552, 0xd5 }, // ╒
    { 0x2553, 0xd6 }, // ╓
    { 0x256B, 0xd7 }, // ╫
    { 0x256A, 0xd8 }, // ╪
    { 0x2518, 0xd9 }, // ┘
    { 0x250C, 0xda }, // ┌
    { 0x2588, 0xdb }, // █
    { 0x2584, 0xdc }, // ▄
    { 0x258C, 0xdd }, // ▌
    { 0x2590, 0xde }, // ▐
    { 0x2580, 0xdf }, // ▀
    { 0x03B1, 0xe0 }, // α
    { 0x00DF, 0xe1 }, // ß
    { 0x0393, 0xe2 }, // Γ
    { 0x03C0, 0xe3 }, // π
    { 0x03A3, 0xe4 }, // Σ
    { 0x03C3, 0xe5 }, // σ
    { 0x00B5, 0xe6 }, // µ
    { 0x03C4, 0xe7 }, // τ
    { 0x03A6, 0xe8 }, // Φ
    { 0x0398, 0xe9 }, // Θ
    { 0x03A9, 0xea }, // Ω
    { 0x2126, 0xea }, // Ω
    { 0x03B4, 0xeb }, // δ
    { 0x221E, 0xec }, // ∞
    { 0x03C6, 0xed }, // φ
    { 0x03B5, 0xee }, // ε
    { 0x2229, 0xef }, // ∩
    { 0x2261, 0xf0 }, // ≡
    { 0x00B1, 0xf1 }, // ±
    { 0x2265, 0xf2 }, // ≥
    { 0x2264, 0xf3 }, // ≤
    { 0x2320, 0xf4 }, // ⌠
    { 0x2321, 0xf5 }, // ⌡
    { 0x00F7, 0xf6 }, // ÷
    { 0x2248, 0xf7 }, // ≈
    { 0x00B0, 0xf8 }, // °
    { 0x2219, 0xf9 }, // ∙
    { 0x00B7, 0xfa }, // ·
    { 0x221A, 0xfb }, // √
    { 0x207F, 0xfc }, // ⁿ
    { 0x00B2, 0xfd }, // ²
    { 0x25A0, 0xfe }, // ■
    { 0x00A0, 0xff } // NBSP
};

/* Recherche simple dans la table */
static uint8_t unicode_to_cp437(uint16_t uc)
{
    for (unsigned i = 0; i < sizeof(utf8_cp437_table) / sizeof(utf8_cp437_table[0]); i++) {
        if (utf8_cp437_table[i].unicode == uc) {
            return utf8_cp437_table[i].cp437;
        }
    }
    return '?';
}

/*
 * Décode UTF-8 minimal :
 * - ASCII
 * - UTF-8 2 bytes (U+0080 à U+07FF)
 * Le reste est remplacé
 */
size_t utf8_to_cp437(const char *utf8, char *cp437, size_t cp437_size)
{
    size_t out = 0;
    const unsigned char *s = (const unsigned char *)utf8;

    while (*s && out + 1 < cp437_size) {

        // ASCII direct (printables)
        if (*s <= 0x007e && *s >= 0x0020) {
            cp437[out++] = *s++;
            continue;
        }
        // CP437 control glyphs (0x01..0x1F)
        if (*s > 0x00 && *s < 0x20) {
            cp437[out++] = *s++;
            continue;
        }

        // UTF-8 2 bytes : 110xxxxx 10xxxxxx
        if ((s[0] & 0xE0) == 0xC0 && s[1] && (s[1] & 0xC0) == 0x80) {
            uint16_t uc =
                ((s[0] & 0x1F) << 6) |
                (s[1] & 0x3F);

            if (uc == 0xFE0E || uc == 0xFE0F) {
                s += 2;
                continue;
            }
            uint8_t mapped = unicode_to_cp437(uc);
            if (mapped == '?' && uc != 0x003F) {
                cp437[out++] = *s++;
                continue;
            }
            cp437[out++] = mapped;
            s += 2;
            continue;
        }

        // UTF-8 3 bytes : 1110xxxx 10xxxxxx 10xxxxxx
        if ((s[0] & 0xF0) == 0xE0 &&
            s[1] && (s[1] & 0xC0) == 0x80 &&
            s[2] && (s[2] & 0xC0) == 0x80) {
            uint16_t uc =
                ((s[0] & 0x0F) << 12) |
                ((s[1] & 0x3F) << 6) |
                (s[2] & 0x3F);
            if (uc == 0xFE0E || uc == 0xFE0F) {
                s += 3;
                continue;
            }
            uint8_t mapped = unicode_to_cp437(uc);
            if (mapped == '?' && uc != 0x003F) {
                cp437[out++] = *s++;
                continue;
            }
            cp437[out++] = mapped;
            s += 3;
            continue;
        }

        // Octet non UTF-8 : assume déjà en CP437
        if (*s >= 0x80) {
            cp437[out++] = *s++;
            continue;
        }

        // Tout le reste : caractère non supporté
        cp437[out++] = '?';
        s++;
    }

    cp437[out] = 0;
    return out;
}

/*static uint16_t utf8_next(const unsigned char **p)
{
    const unsigned char *s = *p;
    uint16_t cp;

    if (s[0] < 0x80) {
        cp = s[0];
        (*p)++;
    } else if ((s[0] & 0xE0) == 0xC0) {
        cp = ((s[0] & 0x1F) << 6) |
              (s[1] & 0x3F);
        (*p) += 2;
    } else if ((s[0] & 0xF0) == 0xE0) {
        cp = ((s[0] & 0x0F) << 12) |
             ((s[1] & 0x3F) << 6) |
              (s[2] & 0x3F);
        (*p) += 3;
    } else {
        cp = '?';
        (*p)++;
    }

    return cp;
}*/
